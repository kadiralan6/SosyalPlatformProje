{% extends "base.html" %}

{% block title %}Harita - SABİS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<style>
  #map {
    width: 100%;
    height: 600px;
    border-radius: var(--radius-lg);
    z-index: 1;
  }
</style>
{% endblock %}

{% block content %}
<div class="fade-in">
  <div class="card mb-4">
    <h2 class="card-title">Kullanıcı Konumları</h2>
    <p class="text-muted">Harita üzerinde kullanıcıların konumlarını görün</p>
  </div>

  <div class="card">
    <div id="map"></div>

    <div class="mt-3">
      <button id="addLocation" class="btn btn-primary">Konumumu Ekle</button>
      <p class="text-muted mt-2">Harita üzerinde bir noktaya tıklayarak konumunuzu ekleyebilirsiniz</p>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
  let map;
  let markers = [];
  let addingLocation = false;
  // Pass locations from Flask to JS safely
  const locations = {{ locations| tojson | safe }};

  function initMap() {
    // Default center (Turkey)
    const center = [39.9334, 32.8597];

    // Initialize Leaflet map
    map = L.map('map').setView(center, 6);

    // Add OpenStreetMap tiles (Free & Open Source)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Add existing locations
    locations.forEach(location => {
      addMarker(location.latitude, location.longitude, location.user.first_name + ' ' + location.user.last_name);
    });

    // Add location on click button handler
    document.getElementById('addLocation').addEventListener('click', () => {
      addingLocation = !addingLocation;
      const btn = document.getElementById('addLocation');

      if (addingLocation) {
        btn.textContent = 'İptal';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-danger');
        document.getElementById('map').style.cursor = 'crosshair';
      } else {
        btn.textContent = 'Konumumu Ekle';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-primary');
        document.getElementById('map').style.cursor = '';
      }
    });

    // Map click event
    map.on('click', (e) => {
      if (addingLocation) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;

        // Show loading state
        const btn = document.getElementById('addLocation');
        btn.textContent = 'Kaydediliyor...';
        btn.disabled = true;

        // Save location
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        fetch('/map/update', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: JSON.stringify({
            latitude: lat,
            longitude: lng,
            address: ''
          })
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Konumunuz kaydedildi!');
              location.reload();
            } else {
              alert('Hata oluştu!');
              resetButton();
            }
          })
          .catch(err => {
            console.error(err);
            alert('Bağlantı hatası!');
            resetButton();
          });
      }
    });
  }

  function resetButton() {
    addingLocation = false;
    const btn = document.getElementById('addLocation');
    btn.textContent = 'Konumumu Ekle';
    btn.classList.remove('btn-danger');
    btn.classList.add('btn-primary');
    btn.disabled = false;
    document.getElementById('map').style.cursor = '';
  }

  function addMarker(lat, lng, title) {
    const marker = L.marker([lat, lng]).addTo(map);
    marker.bindPopup(`<strong>${title}</strong>`);
  }

  // Initialize map when page loads
  window.onload = initMap;
</script>
{% endblock %}